---
title: 面试相关-分库分表
date: 2020-02-19 16:33:51
tags: [面试相关]
---

#  数据库分库分表

### 为什么要分库分表

```
1.单机数据库磁盘快满了
2.单机数据库 撑不住并发 单机 (800-1200 差不多了)
3.表数据量很大 查询效率下降 (数据800w以上)
```



<!--more-->

### 分库/分表

```
->根据一定的hash算法 分发原有数据进入 其他库(表结构相等)
->这样降低了单库的磁盘使用率,降低了单表的数据量(提高了查询效率)
->后续  在根据算法 将数据插入不同的表
```

### 数据库中间件

```
1.sharding-jdbc  
   ->属于client层方案
   ->引用jar包 技术维护  
   -> 支撑 分库分表 ,分布式id,读写分离,柔性事务(最大努力通知事务,TCC事务)
   
2.MyCat
   -> 属于proxy层方案 基于cobar改造的
   -> 需要专人运维

```

### 一般来说 数据库水平切割还是垂直切割

#### 水平切割

```
将数据库的表数据 均匀分布在不同的表上  合并起来就是完整数据
作用 :用来抗住更高的并发
```

#### 垂直切割

```
冷热数据分离
将表中的常用字段和不常用字段 分开两张表存放 
这样常用字段的表的字段越少 ,性能越高
```

### 数据库迁移方案

```
1. 长停机迁移方案
  ->系统维护 无法访问
  

2. 双写方案
 ->不停机 
 ->修改原有系统写库代码 添加中间件同时插入新的数据库  (也就是同时写入 老库 新库)
 ->然后基于导数工具 将之前的数据(读取出来的数据新库没有 或者时间戳字段比新库新)插入到新数据库中  
 -> 导入一轮之后 可能还是会有数据一致性的问题 利用程序自动比对新老数据库的每一条数据 如果有不同的数据,从老库读取写入 ,直到两边数据库的数据一致 (这边可能要开好几台机子 循环往复的执行好几天)
 ->然后将其他 分库分表的系统重新部署上去就 ok了
```

### 分库分表后 数据库分布式id的方案

```
1.单独搞一个数据库(全局就一个) 来创建id 自增     (并发低)

2.uuid 可能太长 导致主键性能差   

3.获取当前时间+业务id (并发高的情况下 不适用)

4. snowflake雪花算法   (可能存在时钟回拨的情况)

```



### 数据库读写分离的原理

```
1.集群模式

2.主从同步 读写分离

原理:
 1.会有个binlog日志, 从库连接到主库后,从库会有个I线程,将主库的binlog日志拷贝到本地,然后写入中继日志
 2.然后从库会有个SQL线程读取日志,重新执行一遍sql 保证主库从库数据一致 
 3.从库同步主库的过程是串行化的,高并发情况下从库的数据一定会比主库慢一点,延时
 4. 5.6版本以后支持多线程读取binlog日志
 
 两种同步方案:
    ->1. 半同步机制 解决主库数据丢失问题
         | 主库写入数据 同步到从库 返回ack之后才算写入成功
    
    ->2. 并行复制  解决主从同步的延时问题 5.7版本以后
         |并行读取relay log日志,并且并行重放日志

```

#### 主从延时 如何处理?

```
    ->1. 半同步机制 解决主库数据丢失问题
         | 主库写入数据 同步到从库 返回ack之后才算写入成功
    
    ->2. 并行复制  解决主从同步的延时问题 5.7版本以后
         |并行读取relay log日志,并且并行重放日志
         
         
  在读多写少的情况下 使用主从同步
  如果在一定要保证数据实时性的情况下 那可以使用数据库中间件来保证强制读取主库数据
```

# 真题

## 如何系统不停机迁移到分库分表

```
1. 停机迁移方案

2. 双写方案
```

## 如何设置动态扩容伸缩的分库分表

```
1.选择数据库中间件   ->调研保证没问题
2.设计一个分库分表的方案  ->设置多个库 多少个表
3.基于选择好的数据库中间件, 以及在测试环境建立的分库分表的环境->测试分库分表是否能正常读写
4.完成单库单表-> 分库分表的迁移 ->双写方案
5.线上系统基于分库分表的方案对外服务


方案一: 停机扩容  (数据量太大 不靠谱)

方案二: 利用32*32 来分库分表   在设计表上就已经考虑这个问题   (甚至 128 256 512)
     ->即分为32个库,每个库的一个表分为32张表, 一共是1024张表
     ->然后 某个id先根据32取模路由到库,在根据32取模路由到库的表
     
     ->前期情况下 可以在一个数据服务器上创建多个逻辑库 来保证 扩容前的服务器数量少 而不是一次性架上32台
     -> 比如 4台服务器 32个库
     ->扩容的情况下 :就将 A数据服务器上的库迁移4个库 -> 弄到新的数据库服务器上就ok了
     -> 表数量不变  只迁移数据库
     ->如果在超过32个库的情况下  比如迁移64台机子 那么可以将32张表 迁移16张表到新的机子上
     

```

