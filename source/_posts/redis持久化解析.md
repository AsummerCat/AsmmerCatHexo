---
title: redis持久化解析
date: 2020-06-07 18:36:47
tags: [redis]
---

# redis持久化解析

## RDB 冷备
```
镜像文件->全量数据备份
恢复时->加载快
可能会丢失一大部分数据(定时几分钟备份一次,最后一个时间窗口期的数据丢失)
```

## AOF 热备

```
 重载操作 日志->每一个操作追加到日志文件
恢复时->加载慢 (因为要重新回放日志记录),有冗余(每个操作都会执行 可能存在大批量无效日志)
丢失数据少,如果存在异常操作可能导致数据恢复不完全
```

## redis4.x之前默认是RDB模式
```
AOF就会拉低redis性能 (因为写操作都要记日志)

```
## 新版本可以开启混合模式

<!--more-->

```
底层还是一个AOF文件

在AOF文件里 开头
会在一定的时间窗口期内 使用RDB的快照(直接快速恢复),
然后再追加日志

配置文件中:
修改是否混合模式
aof-use-rdb-preamble no

关闭快照:
save ""
(因为混合模式默认有RDB)

```
## redis自带压测工具

```
命令: redis-benchmark

例如:
5000并发 -n 1w个请求 -q 静默模式 -t set (只操作这个set行为)

redis-benchmark  -c 5000 -n 10000 -q -t -set

具体参数 : redis -benchmark --help

需要注意 要修改系统文件描述符大小
不然 可能无法开启那么多线程去压测
查看当前进程文件描述符大小:
ulimit -n
修改文件描述符大小:
ulimit -SHn 100000
```

# 集群:主从复制

## 第一种  (同步)  强一致性
```
主库接收消息后 同步到从库 才算 保存成功了

缺点:
CP 一致性会破坏可用性,性能也会下降
```

## 第二种  (异步)  弱一致性(redis默认)
```
主库接收请求 保存成功 返回客户端, 
再接着同步从库

缺点: 弱一致性,没有数据一致性的保障

```