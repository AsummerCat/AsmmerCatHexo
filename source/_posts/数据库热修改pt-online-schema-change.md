---
title: 数据库热修改pt-online-schema-change
date: 2018-10-23 17:29:35
tags: [数据库]
---

[线上数据库字段扩容引发业务方超时总结](https://www.cnblogs.com/LipeiNet/p/9182454.html)  
[使用pt-online-schema-change在线修改MySQL表结构](http://www.ywnds.com/?p=4442)

# alter修改原理

<!--more-->

```
1.先进行锁表
2.创建一张临时表
3.将老表的数据拷贝到临时表中
4.修改源表名为old表,把新表的表名修改为源表名,删除old表
```

# 热修改原理

```
1.创建一张临时表(表结构则是修改后的表结构),并从源数据表向新表导入数据
2.创建触发器,用于记录从导入数据期间所有操作表(增删改)的操作,主要用于拷贝后执行触发器保证数据不会丢失
3.导入数据结束后短暂锁表然后执行触发器
4.修改源表名为old表,把新表的表名修改为源表名,删除old表
5.删除触发器
```

# 后续问题规避

```
如果不到不得已不建议修改线上数据苦,如果真的修改注意下面几点

1.找dba分析修改的源数据表需要锁表的时间(数据量小采用alter,量大则采用热修改)
2.是否可以接受锁表的时间(如果不能接受则需要采用其他方式)
3.修改表安排在流量小的时候比如晚上6点后,并观察dba数据连接池变化、日志变化、服务耗时的时长等,如果有异常停止修改
```
# 工具简介

pt-osc模仿MySQL内部的改表方式进行改表，但整个改表过程是通过对原始表的拷贝来完成的，即在改表过程中原始表不会被锁定，并不影响对该表的读写操作。

首先，osc创建与原始表相同的不包含数据的新表并按照需求进行表结构的修改，然后将原始表中的数据按chunk大小逐步拷贝到新表中，当拷贝完成后，会自动同时修改原始表和新表的名字并默认将原始表删除

这个过程中有两个问题需要注意：

1. 触发器

因为整个过程是在线的，为了将改表过程中对原始表的更新同时更新到新表上，会创建相应的触发器，每当发生针对原始表的增删改操作，就会触发对新表的相应的操作。所以原始表上不能有其他触发器，即如果原始表上存有触发器，OSC会罢工的

2. 外键

外键使改表操作变得更加复杂，如果原始表上有外键的话，自动rename原始表和新表的操作就不能顺利进行，必须要在数据拷贝完成后将外键更新到新表上，该工具有两种方法来支持这个操作，具体后面参数部分（--alter-foreign-keys-method）介绍