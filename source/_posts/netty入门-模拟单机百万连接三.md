---
title: netty入门-模拟单机百万连接三
date: 2019-11-12 17:36:40
tags: [netty]
---

# netty模拟单机百万连接

一个server 最大可匹配1025-65525个连接

![](/img/2019-12-22/1.png)

<!--more-->

# 调优

## 突破局部文件句柄限制

-->突破单进程最大连接数

### ulimit -n  (linux中一个进程打开的最大文件数)

 ###   打开 sudo vi /etc/security/limits.conf

文末加入:

`* 表示当前用户 hard打开最大文件 soft警告 1000000最大文件数`

```linux
* hard nofile 1000000
* soft nofile 1000000
```

## 突破全局文件句柄限制

-->突破全局最大连接数

//所有进程打开的总文件数大小

`cat /proc/sys/fs/file-max`

### 第一步 打开修改  /etc/security/limits.conf

```linux
echo 20000 > /etc/security/limits.conf
```

(提示:这边重启后就重置了)

### 第二部 打开修改 cat /etc/sysctl.conf

->文末添加文件最大句柄

```
fs.file-max=1000000 
```

->保存后 执行 生效

```
sysctl -p
```

->查看修改后的结果

```
cat /proc/sys/fs/file-max
```

这样就可以实现单机百万连接

# 提升qps

## 方式一

### 第一步 业务处理异步化

可以把接收服务端接收客户端请求 然后 处理业务返回这部分 用业务线程做处理 (cpu*2)

避免堵塞线程

 原流程 : 客户端请求-> 服务端接收 ->服务端响应及其业务处理->服务端处理后响应 ->客户端接收 (同步)

改造后流程: 客户端请求->服务端接收->服务端响应->服务端(多线程)处理业务(异步)->服务端业务处理后响应  ->客户端接收

### 第二步 业务线程数调整

线程数 跟响应时间 调整至相对的优化 

+线程  并且降低响应时间

​                                                 

## 方式二 服务器接收请求的handler创建一个单独的worker去工作处理

给予 worker      调整线程数

  ![](/img/2019-12-22/2.png)

