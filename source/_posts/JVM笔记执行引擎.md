---
title: JVM笔记执行引擎
date: 2020-07-22 15:03:36
tags: [JVM笔记]
---

# JVM笔记执行引擎
## 执行引擎概述
![执行引擎概述](/img/2020-07-02/57.png)  

<!--more-->
![JVM主要任务](/img/2020-07-02/58.png)  
## 执行引擎工作流程
![执行引擎工作流程](/img/2020-07-02/59.png)  

## java代码编译和执行的过程

#### 什么是解释器和JIT编译器
```
1. 解释器就是:逐行解释代码->以字节码逐行解释的方式执行 

2. JIT编译器: 将源代码转换为机器码 加快速度 ,例如热点代码就是这么操作的

```
![什么是解释器和JIT编译器](/img/2020-07-02/60.png)  

#### 执行引擎执行的大致流程图
![执行引擎执行的大致流程图](/img/2020-07-02/61.png)  


### 解释器的使用
![解释器的使用](/img/2020-07-02/62.png)   
解释器分类:  
![解释器分类](/img/2020-07-02/63.png)  

## 解释器和JIT编译器如何共存
### 运行时分类
![运行时分类](/img/2020-07-02/64.png)  

### 为什么需要解释器和JIT编译器混合执行
```
因为: 
  JVM启动的时候,首先解释器就可以直接逐行运行了,不必编译
  
  不像JIT编译器一样需要等待JIT编译转机器码后再运行.
  
后期的话: 因为有热点代码存在  
  直接用元空间的JIT缓存执行效率更好
  所以这样混合运行后:=>
  启动时候可以直接运行->后期速度也会越来越快
  
还有个点:
 解释执行可以当做后备方法
 比如JVM进行激进的优化的时候失败了 ,还可以解释器逐行运行,避免宕机

```

![为什么需要解释器和JIT编译器混合执行](/img/2020-07-02/65.png)  

### Hotspot的执行方式

![Hotspot的执行方式](/img/2020-07-02/66.png) 

# JIT编译器

## Hotspot VM的JIT编译器
```
Hotspot VM的 C1 和 C2编译器

自JDK10之后 新增了一个全新的即时编译器`Graal`编译器
开启参数:
-XX:+UnlockExperimentalVMOptions
-XX:+UseJVMCICompiler 
这样激活才可以使用


```

#### Hotspot JVM的运行方式参数
```
-Xint   :完全采用解释运行的方式

-Xcomp  :完全采用JIT编译器的方式

-Xmixed :采用解释运行和JIT编译器混合运行 (默认)

切换方式:
java -Xint -version
```

##### C1  JIT编译器  这个就是Client模式
```
-Client 指定JVM使用客户端模式运行,
达到效果: 
 C1编译器对字节码进行简单和可靠的优化,耗时短,以达到更快的编译速度

32位系统默认

调用:
java -Client -Version
```

##### C2  JIT编译器  这个就是Server模式
```
-Server 指定JVM使用服务端模式运行
达到效果: 
 C2编译器进行耗时较长的优化,深度优化.但优化的代码执行效率更高

64位系统默认

调用:
java -Server -Version
```

##### C1和C2编译器不同的优化策略
注意一点: 在jdk1.7之后 如果显性开启`-Server`   
默认会开启分层策略->即使用C1和C2协作共同执行编译任务

![C1和C2编译器不同的优化策略](/img/2020-07-02/68.png) 


## 热点代码探测何时使用JIT编译器
```
根据 代码被调用频次来决定的 
这些代码称为"热点代码"

JIT编译器会对这些代码进行深度优化->转换为机器码,以此提升JAVA程序执行效率

```
## 如何判断为热点代码
采用基于`计数器`的热点探测
![热点代码及其探查方式](/img/2020-07-02/67.png) 

##### 方法调用计数器 -XX:CompileThreshold
这个是用来统计方法调用次数的

```
client模式下:1500次
server模式下:10000次
超过这个阀值会触发JIT编译

阀值可以由JVM参数手动控制:
`-XX:CompileThreshold `来人为设定

需要注意:
有一个热度衰减的概念 

避免计数器无限增长 ->就跟hystrix的时间窗口一样

如果在一定时间段内,代码的调用次数不够提交给JIT编译..
那么这个方法的计数器就会`减少一半`

这个热度衰减 也是可以有JVM参数控制的
JVM参数:
`-XX:CompileThreshold`  来设置阀值触发JIT编译

`-XX:-UseCounterDecay`   来手动关闭热度衰减

`-XX:CounterHalfLifeTime`   来设置窗口期,单位是秒
```

##### 回边计数器 
这个是用来统计方法的循环体代码执行的次数  